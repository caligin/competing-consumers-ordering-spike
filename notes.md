# Problems

- mongo concurrent updates: 2 workers might end up working on the same mongo document at the same time, incurring in "lost update" problems. While real, this is unilkely enough to decide to delay it.
- competing consumers + group ordering: competing consumers pick messages from the same queue. messages belong to some form of group (e.g. "all relative to same crs"), and they need to be processed in order as they relate to the state of a single entity to be processed. without any concept of neither ordering nor grouping it is not possible to guarantee that 2 competing consumers will not pick up 2 events related to the same entity, thus processing them concurrently and potentially out of order (causing data inconsistencies, lost updates or other unpleasant situations)
  - consistent hashing on group + rabbit ordering guarantee? hashing would guarantee that messages pertaining to the same group are processed on the same worker, thus enabling the ability of enforcing linearization of processing. ordering would be enforced by rabbit.
  - by-group sequence numbering from the source + state synchronization of the workers? source of events must know which is the last sequence number emitted for a given group. emit the next sequence number on the next event etc. consumers keep track of the same sequence number and they process if newN == curN+1 and requeue otherwise. Livelock of a service always picking up the same message that it can't process (e.g. processing state is in-memory: P1 processes M1 and can now process M2. P2 gets M2 but doesn't know that P1 processed M1, therefore requeues. If we're unlucky M2 might keep going to P2) is avoided with state synchronization across the workers at the beginning/end of each processing (query "what's current number" first, tell "this is latest number" at the end). Might be out-of-sync for a while but will eventually complete. (TODO: is this subject of emission of duplicated sequence numbers at the source b/c state sync there?)
  - @see activemq message groups](http://activemq.apache.org/message-groups.html)
- application "lies" by replying to the synchronous request while the actual state transition is still being carried on in the background. 
